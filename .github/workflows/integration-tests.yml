# https://help.github.com/en/categories/automating-your-workflow-with-github-actions

name: "Integration tests"

on:
  workflow_call:
    inputs:
      ref:
        description: 'phpstan/phpstan ref to checkout'
        required: true
        type: string

jobs:
  integration-tests:
    name: "Integration Tests"

    runs-on: "ubuntu-latest"

    strategy:
      fail-fast: false
      matrix:
        php-version:
          - 7.4
        script:
          - |
            git clone --filter=blob:none https://github.com/nunomaduro/larastan.git e2e/integration/repo
            cd e2e/integration/repo
            git checkout 48a09d12b1e6e9f22b81af370d44bbf91883cebe
            composer install
            ../../../phpstan.phar analyse -c ../larastan.neon
          - |
            git clone --filter=blob:none https://github.com/slevomat/coding-standard.git e2e/integration/repo
            cd e2e/integration/repo
            git checkout c6282eefa680e3c982ea41a8df4ce2e5402eed6a
            composer install
            composer require --dev phpstan/phpstan:^1.0 phpstan/phpstan-strict-rules:^1.0 phpstan/phpstan-phpunit:^1.0 phpstan/phpstan-deprecation-rules:^1.0
            ../../../phpstan.phar analyse -c ../slevomat-cs.neon -l 7 SlevomatCodingStandard
            ../../../phpstan.phar analyse -c build/PHPStan/phpstan.tests.neon -l 7 tests
          - |
            git clone --filter=blob:none https://github.com/nextras/orm.git e2e/integration/repo
            cd e2e/integration/repo
            git checkout 4edfc4957494ec272899a8916f3f245c59c86d05
            composer install
            ../../../phpstan.phar analyse -c ../nextras.neon
          - |
            git clone --filter=blob:none https://github.com/bitExpert/phpstan-magento.git e2e/integration/repo
            cd e2e/integration/repo
            git checkout f845cd4dbdc49d2e005ec2646176ddfcf7d55d38
            composer install
            ../../../phpstan.phar analyse -c ../magento.neon
        include:
          - php-version: 8.1
            script: |
              git clone --filter=blob:none https://github.com/rectorphp/rector-src.git e2e/integration/repo
              cd e2e/integration/repo
              git checkout a82a18edd366575db60151880ca44f1a8c2a0120
              cp ../rector-composer.lock composer.lock
              composer install
              ../../../phpstan.phar analyse -c ../rector.neon
          - php-version: 8.0
            script: |
              git clone --filter=blob:none https://github.com/sebastianbergmann/phpunit.git e2e/integration/repo
              cd e2e/integration/repo
              git checkout 9.5.6
              export COMPOSER_ROOT_VERSION=9.5.6
              composer install
              ../../../phpstan.phar analyse -l 8 -c ../phpunit.neon src tests
          - php-version: 8.0
            script: |
              git clone --filter=blob:none https://github.com/pmmp/PocketMine-MP.git e2e/integration/repo
              cd e2e/integration/repo
              git checkout e0b07ff3087b652407439a29c941f3b66ca92c86
              composer install --ignore-platform-reqs
              ../../../phpstan.phar analyse -c ../pocketmine.neon --memory-limit=2G
          - php-version: 8.0
            script: |
              git clone --filter=blob:none https://github.com/laravel/framework.git e2e/integration/repo
              cd e2e/integration/repo
              git checkout ceadf6ea68c5ef316abfc618879f2cf9290e45b3
              composer install
              ../../../phpstan.phar analyse
          - php-version: 8.1
            script: |
              git clone --filter=blob:none https://github.com/Roave/BetterReflection.git e2e/integration/repo
              cd e2e/integration/repo
              git checkout 50970c323d45c6b69d20eb620e03980374aac3dd
              composer install
              ../../../phpstan.phar
          - php-version: 8.1
            script: |
              git clone --filter=blob:none https://github.com/composer/composer.git e2e/integration/repo
              cd e2e/integration/repo
              git checkout b9c368a9c3146a9b4b7b387bbd4fba4c80b8e3b7
              composer install
              composer config platform --unset && composer update
              vendor/bin/simple-phpunit --filter NO_TEST_JUST_AUTOLOAD_THANKS
              ../../../phpstan.phar analyse -c ../composer.neon

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v2"
        with:
          repository: "phpstan/phpstan"
          ref: ${{ inputs.ref }}

      - name: "Install PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          coverage: "none"
          php-version: "${{ matrix.php-version }}"

      - name: "Install dependencies"
        run: "composer update --no-interaction --no-progress"

      - name: "Download phpstan.phar"
        uses: actions/download-artifact@v2
        with:
          name: phar-file

      - name: "Tests"
        run: "${{ matrix.script }}"
